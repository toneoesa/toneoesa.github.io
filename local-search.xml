<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>优雅地使用VSCode连接chroot环境</title>
    <link href="/20231014/52d5df4677b9/"/>
    <url>/20231014/52d5df4677b9/</url>
    
    <content type="html"><![CDATA[<p>很多时候使用chroot是为了在与主机隔离的环境中进行开发，而VSCode并没有支持chroot环境。于是参考一个 Issue <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Github Issue：https://github.com/microsoft/vscode-remote-release/issues/982">[1]</span></a></sup>，我发现了一种较为优雅的使用VSCode连接chroot环境的方法。</p><p>总体来说，先使用schroot开启一个session，再配置ssh server进行chroot，从而使用VSCode的Romte SSH插件连接到chroot环境。</p><h2 id="schroot-配置"><a href="#schroot-配置" class="headerlink" title="schroot 配置"></a>schroot 配置</h2><p>schroot可以用来简化chroot的操作，比如在chroot前自动进行挂载路径、拷贝文件等操作，也可以方便地在不同chroot环境中切换。</p><p>Archlinux下schroot的配置文件在 <code>/etc/schroot</code>，其中 <code>schroot.conf</code>是主配置文件，<code>chroot.d</code>下放置各个chroot环境的配置，<code>setup.d</code> 下放置的了chroot启动时应执行的脚本，剩下的每个文件夹是一个”profile”，包含<code>copyfiles</code>、<code>fstab</code>、<code>nssdatabases</code> 三个文件，有时还有 <code>config</code> 文件。</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;schroot&#x2F;├── arch32&#x2F;├── buildd&#x2F;├── chroot.d&#x2F;├── default&#x2F;├── desktop&#x2F;├── minimal&#x2F;├── sbuild&#x2F;├── schroot.conf└── setup.d&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;schroot&#x2F;default&#x2F;├── copyfiles├── fstab└── nssdatabases<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>要配置schroot，应在 <code>chroot.d</code> 中新建一个文件，参考该目录下自带的示例，我的配置文件如下。</p><figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">bookworm</span><span class="token punctuation">]</span></span><span class="token key attr-name">description</span><span class="token punctuation">=</span><span class="token value attr-value">Debian Bookworm</span><span class="token key attr-name">aliases</span><span class="token punctuation">=</span><span class="token value attr-value">deb</span><span class="token key attr-name">type</span><span class="token punctuation">=</span><span class="token value attr-value">directory</span><span class="token key attr-name">directory</span><span class="token punctuation">=</span><span class="token value attr-value">/srv/chroot/bookworm</span><span class="token key attr-name">users</span><span class="token punctuation">=</span><span class="token value attr-value">zy,zydeb</span><span class="token key attr-name">root-users</span><span class="token punctuation">=</span><span class="token value attr-value">zy,zydeb</span><span class="token key attr-name">profile</span><span class="token punctuation">=</span><span class="token value attr-value">my_profile</span><span class="token key attr-name">personality</span><span class="token punctuation">=</span><span class="token value attr-value">linux</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>directory</code> 是chroot目录，这目录下一般应该是一个Linux发行版的根目录，可以用 <a href="https://wiki.debian.org/Debootstrap">debootstrap</a> 创建。</li><li><code>users</code>, <code>root-users</code> 是主机上的用户，此处创建一个了额外的用户，是为了后面配置ssh。</li><li><code>profile</code> 就是上面说到的 profile，可以根据需要选择一个或自己编写。</li></ul><p>现在就能进入chroot环境了。</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">schroot <span class="token parameter variable">-c</span> bookworm <span class="token parameter variable">-u</span> root <span class="token parameter variable">-d</span> /root<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>可以先用root用户登录进行一些配置，如更换镜像源、安装软件包、添加用户等。</p><p>一般会添加主机上存在的用户，方便普通用户直接登录。配置好后，就能以普通用户身份登录了。</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">schroot <span class="token parameter variable">-c</span> bookworm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>值得一提的是，不指定时，默认使用当前用户名和当前目录。所以当 chroot 环境中不存在同名用户或同名目录时，可能会看到警告甚至不能 chroot。</p><h2 id="schroot-session"><a href="#schroot-session" class="headerlink" title="schroot session"></a>schroot session</h2><p>schroot 有一个 “session“ 功能，按 schroot 手册页<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="schroot-faq(7)： https://manpages.debian.org/testing/schroot/schroot-faq.7.en.html#How_do_I_use_sessions?">[2]</span></a></sup>的说法，这可以从程序或脚本运行任意数量的命令，并在命令间保持状态，而且每次进入chroot都创建了一个 session，只是在退出时 session 关闭了而已。</p><p>其实创建 session 的过程实际是创建了一个“挂载点”（是否还有其他操作并不清楚）。如果使用 schroot 进入 chroot 环境且不要退出，可以发现它在 <code>/run/schroot/mount</code> 下挂载了一些目录。以下是 mount 命令的输出（进行了一些删减）。</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&#x2F;dev&#x2F;nvme0n1p5 on &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4 type btrfsproc on &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4&#x2F;proc type procsys on &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4&#x2F;sys type sysfsdev on &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4&#x2F;dev type devtmpfsdevpts on &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4&#x2F;dev&#x2F;pts type devptstmpfs on &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4&#x2F;tmp type tmpfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>其中 <code>bookworm-50f49361-5cbd-420b-bb55-e6355dfeb1c4</code> 是 schroot 随机生成的 session id，总是以配置的“chroot 名字”开头。当然，这也可以手动指定。</p><p>在退出 chroot 环境后，上面的挂载就被自动取消了。</p><p>而 session 功能，就是进行挂载后，可以多次进入 chroot 环境，退出后也不会取消挂载点，直到手动关闭 session，或者重启。</p><p>于是就可以启动 session，从而得到一个固定的“挂载点”，以便后续 ssh 连接。</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">schroot <span class="token parameter variable">-c</span> bookworm <span class="token parameter variable">-b</span> <span class="token parameter variable">-n</span> session_id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>进入、关闭和恢复 session：</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">schroot <span class="token parameter variable">-r</span> <span class="token parameter variable">-c</span> session_idschroot <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> session_idschroot --recover-session <span class="token parameter variable">-c</span> session_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><p>在重启后挂载点会丢失，需要恢复 session （重新启动一个同名 session 似乎也可以，不清楚有无区别）。</p><h2 id="ssh-server-配置"><a href="#ssh-server-配置" class="headerlink" title="ssh server 配置"></a>ssh server 配置</h2><p>在 <code>/etc/ssh/sshd_config</code> 末尾增加规则。</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">Match User zydeb    ChrootDirectory &#x2F;run&#x2F;schroot&#x2F;mount&#x2F;session_id    Subsystem sftp internal-sftp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><p>参考的 Issue <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Github Issue：https://github.com/microsoft/vscode-remote-release/issues/982">[1]</span></a></sup> 中使用了 <code>ForceCommand</code>。</p><p>原本他的用法会报错，他说报错可以忽略，但我使用总会断开连接，于是改成下面这样。</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">Match User zydeb   ForceCommand &#x2F;usr&#x2F;bin&#x2F;schroot -u zydeb -r -c session_id -- $SSH_ORIGINAL_COMMAND   Subsystem sftp internal-sftp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><p>此外，Issue 中还有配置 authorzed_keys 文件来执行命令的方法，但 sftp 和 scp 可能没法使用。</p><p>其中 <code>Subsystem sftp internal-sftp</code>，是为了能让 sftp 和 scp 正常运行，因为 Archlinux 和 Debian 中 sftp-server 的位置不同。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>最后使用 VSCode 的 Remote SSH 连接 <code>zydeb@localhost</code> 即可。</p><p>可以将其写进 <code>.ssh/config</code> 方便连接。</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">Host zydeb    HostName localhost    User zydeb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><section class="footnotes"><h2>参考</h2><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>Github Issue：<a href="https://github.com/microsoft/vscode-remote-release/issues/982">https://github.com/microsoft/vscode-remote-release/issues/982</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>schroot-faq(7)： <a href="https://manpages.debian.org/testing/schroot/schroot-faq.7.en.html#How_do_I_use_sessions">https://manpages.debian.org/testing/schroot/schroot-faq.7.en.html#How_do_I_use_sessions</a>?<a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>博客配置完成~</title>
    <link href="/20231014/44e18e18bcf7/"/>
    <url>/20231014/44e18e18bcf7/</url>
    
    <content type="html"><![CDATA[<p>崭新的博客～</p><p>使用了这些：</p><ul><li><a href="https://hexo.io/">Hexo</a> 静态博客框架</li><li><a href="https://github.com/fluid-dev/hexo-theme-fluid">Fluid</a> 主题</li><li><a href="https://pages.github.com/">Github Pages</a> 功能</li><li><a href="https://giscus.app/">giscus</a> 评论系统</li><li><a href="https://busuanzi.ibruce.info/">不蒜子</a>-极简网页计数器</li></ul><h2 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h2><h3 id="2023-10-14"><a href="#2023-10-14" class="headerlink" title="2023-10-14"></a>2023-10-14</h3><p>Hexo + fluid 主题</p><p>文章永久链接为：<code>:year:month:day/:hash/</code></p><p>开启 Fluid 的脚注功能，注意使用了脚注的文章会被自动加上“参考”节</p><p>giscus 根据 <code>pathname</code> 匹配相应的 Discussion</p><h3 id="2023-10-15"><a href="#2023-10-15" class="headerlink" title="2023-10-15"></a>2023-10-15</h3><p>添加“不蒜子”网页计数器</p><p>展示文章最后更新日期</p><p>设置知识共享许可协议为 BY-SA</p><p>将“平均单词长度”从2调整到5（降低预估的阅读时长）</p><p>代码高亮换用前端 prisimjs（不指定编程语言默认为 text）</p><p>暂时关闭“分类”和“标签”页面，后面有需要了再打开</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
